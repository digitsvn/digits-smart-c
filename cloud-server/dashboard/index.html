<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart C AI - Remote Management</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #0f0f1a 0%, #1a1a2e 50%, #16213e 100%);
            min-height: 100vh;
            color: #fff;
        }

        /* Header */
        .header {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            padding: 20px 40px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            font-size: 24px;
            font-weight: 700;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .status-badge {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            background: rgba(56, 239, 125, 0.2);
            border-radius: 20px;
            font-size: 14px;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            background: #38ef7d;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.5;
            }
        }

        /* Main Layout */
        .container {
            display: grid;
            grid-template-columns: 300px 1fr;
            gap: 20px;
            padding: 20px;
            height: calc(100vh - 80px);
        }

        /* Device List */
        .device-list {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 16px;
            padding: 20px;
            overflow-y: auto;
        }

        .device-list h2 {
            font-size: 16px;
            color: #888;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .device-card {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .device-card:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: #667eea;
            transform: translateX(5px);
        }

        .device-card.active {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.2), rgba(118, 75, 162, 0.2));
            border-color: #667eea;
        }

        .device-card .name {
            font-weight: 600;
            margin-bottom: 5px;
        }

        .device-card .info {
            font-size: 12px;
            color: #888;
        }

        .device-card .status {
            display: flex;
            align-items: center;
            gap: 6px;
            margin-top: 8px;
        }

        .device-card .status.online {
            color: #38ef7d;
        }

        .device-card .status.offline {
            color: #f5576c;
        }

        /* Main Panel */
        .main-panel {
            display: grid;
            grid-template-rows: 1fr auto;
            gap: 20px;
            overflow: hidden;
        }

        /* Screen Viewer */
        .screen-viewer {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 16px;
            padding: 20px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .screen-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            flex-shrink: 0;
        }

        .screen-header h2 {
            font-size: 18px;
        }

        .screen-controls {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: #fff;
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .btn-danger {
            background: linear-gradient(135deg, #f093fb, #f5576c);
            color: #fff;
        }

        .btn-success {
            background: linear-gradient(135deg, #11998e, #38ef7d);
            color: #fff;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.3);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .screen-container {
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            background: #000;
            border-radius: 12px;
            overflow: hidden;
            min-height: 300px;
        }

        .screen-container img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }

        .screen-placeholder {
            color: #666;
            text-align: center;
        }

        .screen-placeholder .icon {
            font-size: 64px;
            margin-bottom: 20px;
        }

        /* Control Panel */
        .control-panel {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
        }

        .control-card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 20px;
        }

        .control-card h3 {
            font-size: 14px;
            color: #888;
            margin-bottom: 15px;
        }

        .stat-value {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 12px;
            color: #666;
        }

        .action-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        /* No Device Selected */
        .no-device {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 100%;
            color: #666;
        }

        .no-device .icon {
            font-size: 80px;
            margin-bottom: 20px;
        }

        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            padding: 20px;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            border-radius: 20px;
            width: 100%;
            max-width: 800px;
            max-height: 90vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .modal-header {
            padding: 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h2 {
            font-size: 20px;
        }

        .modal-close {
            background: none;
            border: none;
            color: #888;
            font-size: 24px;
            cursor: pointer;
        }

        .modal-close:hover {
            color: #fff;
        }

        .modal-body {
            padding: 20px;
            overflow-y: auto;
            flex: 1;
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .tab-btn {
            padding: 10px 20px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            color: #888;
            cursor: pointer;
            transition: all 0.3s;
        }

        .tab-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
        }

        .tab-btn.active {
            background: linear-gradient(135deg, #667eea, #764ba2);
            border-color: transparent;
            color: #fff;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Form */
        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #aaa;
            font-size: 14px;
        }

        .form-group select,
        .form-group input {
            width: 100%;
            padding: 12px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            background: rgba(0, 0, 0, 0.3);
            color: #fff;
            font-size: 14px;
        }

        .form-group select:focus,
        .form-group input:focus {
            outline: none;
            border-color: #667eea;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        /* Config Card */
        .config-card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
        }

        .config-card h3 {
            font-size: 16px;
            margin-bottom: 15px;
        }

        /* Toast */
        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 15px 25px;
            border-radius: 10px;
            color: #fff;
            display: none;
            z-index: 2000;
            animation: slideIn 0.3s ease;
        }

        .toast.success {
            background: linear-gradient(135deg, #11998e, #38ef7d);
        }

        .toast.error {
            background: linear-gradient(135deg, #f093fb, #f5576c);
        }

        .toast.active {
            display: block;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }

            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* Responsive */
        @media (max-width: 900px) {
            .container {
                grid-template-columns: 1fr;
            }

            .device-list {
                max-height: 200px;
            }

            .form-row {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>

<body>
    <header class="header">
        <div class="logo">ü§ñ Smart C AI - Remote Management</div>
        <div class="status-badge">
            <span class="status-dot"></span>
            <span id="serverStatus">ƒêang k·∫øt n·ªëi...</span>
        </div>
    </header>

    <div class="container">
        <div class="device-list">
            <h2>
                <span>üì± Thi·∫øt b·ªã</span>
                <button class="btn btn-secondary" onclick="refreshDevices()"
                    style="padding: 5px 10px; font-size: 12px;">‚Üª</button>
            </h2>
            <div id="deviceList">
                <p style="color: #666; text-align: center; padding: 20px;">ƒêang t·∫£i...</p>
            </div>
        </div>

        <div class="main-panel" id="mainPanel">
            <div class="no-device">
                <div class="icon">üì±</div>
                <h2>Ch·ªçn m·ªôt thi·∫øt b·ªã</h2>
                <p style="margin-top: 10px; color: #888;">Ch·ªçn thi·∫øt b·ªã t·ª´ danh s√°ch b√™n tr√°i ƒë·ªÉ xem v√† qu·∫£n l√Ω</p>
            </div>
        </div>
    </div>

    <!-- Config Modal -->
    <div class="modal-overlay" id="configModal">
        <div class="modal">
            <div class="modal-header">
                <h2>‚öôÔ∏è C·∫•u h√¨nh thi·∫øt b·ªã</h2>
                <button class="modal-close" onclick="closeConfig()">√ó</button>
            </div>
            <div class="modal-body">
                <div class="tabs">
                    <button class="tab-btn active" onclick="switchTab('video')">üé¨ Video</button>
                    <button class="tab-btn" onclick="switchTab('audio')">üîä Audio</button>
                    <button class="tab-btn" onclick="switchTab('wakeword')">üé§ Wake Word</button>
                    <button class="tab-btn" onclick="switchTab('wifi')">üì∂ WiFi</button>
                    <button class="tab-btn" onclick="switchTab('system')">üåê H·ªá th·ªëng</button>
                </div>

                <!-- Video Tab -->
                <div class="tab-content active" id="tab-video">
                    <div class="config-card">
                        <h3>üé¨ Video N·ªÅn</h3>
                        <div class="form-group">
                            <label>Ch·ªçn video:</label>
                            <select id="videoSelect">
                                <option value="">ƒêang t·∫£i...</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Ho·∫∑c nh·∫≠p ƒë∆∞·ªùng d·∫´n:</label>
                            <input type="text" id="videoPath" placeholder="assets/videos/video.mp4">
                        </div>
                        <button class="btn btn-primary" onclick="saveVideo()">üíæ L∆∞u Video</button>
                    </div>
                </div>

                <!-- Audio Tab -->
                <div class="tab-content" id="tab-audio">
                    <div class="config-card">
                        <h3>üé§ Thi·∫øt b·ªã Thu (Microphone)</h3>
                        <div class="form-group">
                            <select id="inputDevice">
                                <option value="">ƒêang t·∫£i...</option>
                            </select>
                        </div>
                        <button class="btn btn-success" onclick="testMic()">üé§ Test Mic</button>
                    </div>
                    <div class="config-card">
                        <h3>üîä Thi·∫øt b·ªã Ph√°t (Speaker)</h3>
                        <div class="form-group">
                            <select id="outputDevice">
                                <option value="">ƒêang t·∫£i...</option>
                            </select>
                        </div>
                        <div class="form-row">
                            <button class="btn btn-success" onclick="testSpeaker(false)">üîä Test Speaker</button>
                            <button class="btn btn-success" onclick="testSpeaker(true)">üì∫ Test HDMI</button>
                        </div>
                    </div>
                    <button class="btn btn-primary" onclick="saveAudio()">üíæ L∆∞u Audio</button>
                </div>

                <!-- Wake Word Tab -->
                <div class="tab-content" id="tab-wakeword">
                    <div class="config-card">
                        <h3>üé§ Wake Word (T·ª´ k√≠ch ho·∫°t)</h3>
                        <div class="form-group">
                            <label>Tr·∫°ng th√°i:</label>
                            <select id="wakewordEnabled">
                                <option value="true">‚úÖ B·∫≠t</option>
                                <option value="false">‚ùå T·∫Øt</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Ng∆∞·ª°ng nh·∫°y (0.1 - 1.0):</label>
                            <input type="number" id="wakewordThreshold" min="0.1" max="1" step="0.05" value="0.5">
                        </div>
                        <button class="btn btn-primary" onclick="saveWakeword()">üíæ L∆∞u Wake Word</button>
                    </div>
                </div>

                <!-- WiFi Tab -->
                <div class="tab-content" id="tab-wifi">
                    <div class="config-card">
                        <h3>üì∂ M·∫°ng WiFi</h3>
                        <div class="form-group">
                            <label>M·∫°ng hi·ªán t·∫°i:</label>
                            <div id="currentWifi"
                                style="padding: 10px; background: rgba(0,0,0,0.2); border-radius: 8px;">
                                ƒêang ki·ªÉm tra...
                            </div>
                        </div>
                        <div class="form-group">
                            <label>M·∫°ng kh·∫£ d·ª•ng:</label>
                            <select id="wifiList">
                                <option value="">B·∫•m Qu√©t ƒë·ªÉ xem danh s√°ch</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>M·∫≠t kh·∫©u:</label>
                            <input type="password" id="wifiPassword" placeholder="Nh·∫≠p m·∫≠t kh·∫©u WiFi">
                        </div>
                        <div class="form-row">
                            <button class="btn btn-secondary" onclick="scanWifi()">üîÑ Qu√©t WiFi</button>
                            <button class="btn btn-primary" onclick="connectWifi()">üì∂ K·∫øt n·ªëi</button>
                        </div>
                    </div>
                </div>

                <!-- System Tab -->
                <div class="tab-content" id="tab-system">
                    <div class="config-card">
                        <h3>üåê C·∫•u h√¨nh H·ªá th·ªëng</h3>
                        <div class="form-group">
                            <label>Ng√¥n ng·ªØ:</label>
                            <select id="language">
                                <option value="vi">üáªüá≥ Ti·∫øng Vi·ªát</option>
                                <option value="en">üá∫üá∏ English</option>
                                <option value="zh">üá®üá≥ ‰∏≠Êñá</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>OTA Server URL:</label>
                            <input type="text" id="otaUrl" placeholder="https://api.xiaozhi.me">
                        </div>
                        <div class="form-group">
                            <label>WebSocket URL:</label>
                            <input type="text" id="wsUrl" placeholder="wss://api.xiaozhi.me/websocket">
                        </div>
                        <button class="btn btn-primary" onclick="saveSystem()">üíæ L∆∞u H·ªá th·ªëng</button>
                    </div>
                    <div class="config-card">
                        <h3>üîß H√†nh ƒë·ªông</h3>
                        <div class="action-buttons">
                            <button class="btn btn-secondary" onclick="deviceAction('restart')">üîÑ Restart App</button>
                            <button class="btn btn-secondary" onclick="deviceAction('update')">üì• Git Pull</button>
                            <button class="btn btn-danger" onclick="deviceAction('reboot')">‚ö° Reboot Pi</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="toast" id="toast"></div>

    <script>
        const API_BASE = window.location.origin;
        let selectedDevice = null;
        let autoRefreshInterval = null;

        // ========== Toast ==========
        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = `toast ${type} active`;
            setTimeout(() => toast.classList.remove('active'), 3000);
        }

        // ========== API Functions ==========
        async function fetchDevices() {
            try {
                const resp = await fetch(`${API_BASE}/api/devices`);
                const data = await resp.json();
                return data.devices || [];
            } catch (e) {
                console.error('Error fetching devices:', e);
                return [];
            }
        }

        async function fetchScreenshot(deviceId) {
            try {
                const resp = await fetch(`${API_BASE}/api/devices/${deviceId}/screenshot`);
                if (resp.ok) {
                    const data = await resp.json();
                    return data.image;
                }
                return null;
            } catch (e) {
                return null;
            }
        }

        async function requestScreenshot(deviceId) {
            try {
                await fetch(`${API_BASE}/api/devices/${deviceId}/screenshot/request`, { method: 'POST' });
            } catch (e) {
                console.error('Error requesting screenshot:', e);
            }
        }

        async function sendCommand(deviceId, command, params = {}) {
            try {
                const resp = await fetch(`${API_BASE}/api/devices/${deviceId}/command`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ command, params })
                });
                return await resp.json();
            } catch (e) {
                console.error('Error sending command:', e);
                return { error: e.message };
            }
        }

        // ========== Device List ==========
        async function refreshDevices() {
            const devices = await fetchDevices();
            const container = document.getElementById('deviceList');

            if (devices.length === 0) {
                container.innerHTML = `<p style="color: #666; text-align: center; padding: 20px;">Ch∆∞a c√≥ thi·∫øt b·ªã n√†o k·∫øt n·ªëi</p>`;
                document.getElementById('serverStatus').textContent = '0 thi·∫øt b·ªã';
                return;
            }

            const onlineCount = devices.filter(d => d.status === 'online').length;
            document.getElementById('serverStatus').textContent = `${onlineCount}/${devices.length} online`;

            container.innerHTML = devices.map(d => `
                <div class="device-card ${selectedDevice === d.id ? 'active' : ''}" onclick="selectDevice('${d.id}')">
                    <div class="name">${d.name}</div>
                    <div class="info">${d.ip || 'Unknown IP'}</div>
                    <div class="status ${d.status}">
                        <span>${d.status === 'online' ? 'üü¢' : 'üî¥'}</span>
                        <span>${d.status === 'online' ? 'Online' : 'Offline'}</span>
                    </div>
                </div>
            `).join('');
        }

        async function selectDevice(deviceId) {
            selectedDevice = deviceId;
            document.querySelectorAll('.device-card').forEach(c => c.classList.remove('active'));
            event.currentTarget.classList.add('active');

            const devices = await fetchDevices();
            const device = devices.find(d => d.id === deviceId);
            if (!device) return;

            await requestScreenshot(deviceId);
            setTimeout(() => renderDevicePanel(device), 500);
            startAutoRefresh(deviceId);
        }

        async function renderDevicePanel(device) {
            const screenshot = await fetchScreenshot(device.id);
            const system = device.system || {};

            document.getElementById('mainPanel').innerHTML = `
                <div class="screen-viewer">
                    <div class="screen-header">
                        <h2>üì∫ ${device.name}</h2>
                        <div class="screen-controls">
                            <button class="btn btn-secondary" onclick="refreshScreen('${device.id}')">‚Üª Refresh</button>
                            <button class="btn btn-primary" onclick="openConfig('${device.id}')">‚öôÔ∏è C·∫•u h√¨nh</button>
                        </div>
                    </div>
                    <div class="screen-container">
                        ${screenshot
                    ? `<img src="${screenshot}" alt="Device Screen" id="deviceScreen">`
                    : `<div class="screen-placeholder">
                                <div class="icon">üì∑</div>
                                <p>ƒêang ch·ªù screenshot...</p>
                                <p style="font-size: 12px; margin-top: 10px;">Thi·∫øt b·ªã c·∫ßn c√†i scrot ƒë·ªÉ ch·ª•p m√†n h√¨nh</p>
                               </div>`
                }
                    </div>
                </div>
                
                <div class="control-panel">
                    <div class="control-card">
                        <h3>üíª CPU</h3>
                        <div class="stat-value">${system.cpu_percent || 0}%</div>
                        <div class="stat-label">Usage</div>
                    </div>
                    <div class="control-card">
                        <h3>üß† RAM</h3>
                        <div class="stat-value">${system.memory_percent || 0}%</div>
                        <div class="stat-label">Usage</div>
                    </div>
                    <div class="control-card">
                        <h3>üå°Ô∏è Temp</h3>
                        <div class="stat-value">${system.cpu_temp || 'N/A'}¬∞C</div>
                        <div class="stat-label">CPU</div>
                    </div>
                    <div class="control-card">
                        <h3>üéõÔ∏è Control</h3>
                        <div class="action-buttons">
                            <button class="btn btn-secondary" onclick="deviceAction('restart')">üîÑ Restart</button>
                            <button class="btn btn-danger" onclick="deviceAction('reboot')">‚ö° Reboot</button>
                        </div>
                    </div>
                </div>
            `;
        }

        async function refreshScreen(deviceId) {
            await requestScreenshot(deviceId);
            setTimeout(async () => {
                const screenshot = await fetchScreenshot(deviceId);
                if (screenshot) {
                    const img = document.getElementById('deviceScreen');
                    if (img) img.src = screenshot;
                }
            }, 1000);
        }

        function startAutoRefresh(deviceId) {
            if (autoRefreshInterval) clearInterval(autoRefreshInterval);
            autoRefreshInterval = setInterval(async () => {
                if (selectedDevice === deviceId) {
                    await requestScreenshot(deviceId);
                    setTimeout(async () => {
                        const screenshot = await fetchScreenshot(deviceId);
                        if (screenshot) {
                            const img = document.getElementById('deviceScreen');
                            if (img) img.src = screenshot;
                        }
                    }, 500);
                }
            }, 5000);
        }

        async function deviceAction(action) {
            if (!selectedDevice) return;
            if (action === 'reboot' && !confirm('B·∫°n c√≥ ch·∫Øc mu·ªën reboot thi·∫øt b·ªã n√†y?')) return;

            const result = await sendCommand(selectedDevice, action);
            showToast(result.message || `ƒê√£ g·ª≠i l·ªánh ${action}`);
        }

        // ========== Config Modal ==========
        function openConfig(deviceId) {
            document.getElementById('configModal').classList.add('active');
            // Load initial data
            scanWifi();
        }

        function closeConfig() {
            document.getElementById('configModal').classList.remove('active');
        }

        function switchTab(tabName) {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));

            event.currentTarget.classList.add('active');
            document.getElementById(`tab-${tabName}`).classList.add('active');
        }

        // ========== Config Actions ==========
        async function saveVideo() {
            const videoPath = document.getElementById('videoPath').value || document.getElementById('videoSelect').value;
            if (!videoPath) return showToast('Ch·ªçn ho·∫∑c nh·∫≠p ƒë∆∞·ªùng d·∫´n video', 'error');

            await sendCommand(selectedDevice, 'set_video', { video_path: videoPath });
            showToast('ƒê√£ g·ª≠i c·∫•u h√¨nh video!');
        }

        async function saveAudio() {
            const input = document.getElementById('inputDevice').value;
            const output = document.getElementById('outputDevice').value;

            await sendCommand(selectedDevice, 'set_audio', { input_device: input, output_device: output });
            showToast('ƒê√£ g·ª≠i c·∫•u h√¨nh audio!');
        }

        async function testMic() {
            await sendCommand(selectedDevice, 'test_mic');
            showToast('ƒêang test microphone...');
        }

        async function testSpeaker(hdmi) {
            await sendCommand(selectedDevice, 'test_speaker', { hdmi_audio: hdmi });
            showToast('ƒêang test speaker...');
        }

        async function saveWakeword() {
            const enabled = document.getElementById('wakewordEnabled').value === 'true';
            const threshold = parseFloat(document.getElementById('wakewordThreshold').value);

            await sendCommand(selectedDevice, 'set_wakeword', { enabled, threshold });
            showToast('ƒê√£ g·ª≠i c·∫•u h√¨nh wake word!');
        }

        async function scanWifi() {
            if (!selectedDevice) return;

            document.getElementById('wifiList').innerHTML = '<option>ƒêang qu√©t...</option>';
            await fetch(`${API_BASE}/api/devices/${selectedDevice}/wifi/scan`, { method: 'POST' });

            // Note: WiFi results will be sent via WebSocket - this is a simplified version
            showToast('ƒê√£ g·ª≠i l·ªánh qu√©t WiFi');

            // Simulate loading after 3 seconds
            setTimeout(() => {
                document.getElementById('currentWifi').textContent = 'Xem log ƒë·ªÉ bi·∫øt k·∫øt qu·∫£';
            }, 2000);
        }

        async function connectWifi() {
            if (!selectedDevice) return;

            const ssid = document.getElementById('wifiList').value;
            const password = document.getElementById('wifiPassword').value;

            if (!ssid) return showToast('Ch·ªçn m·∫°ng WiFi', 'error');

            await sendCommand(selectedDevice, 'wifi_connect', { ssid, password });
            showToast('ƒêang k·∫øt n·ªëi WiFi...');
        }

        async function saveSystem() {
            const settings = {
                language: document.getElementById('language').value,
                ota_url: document.getElementById('otaUrl').value,
                ws_url: document.getElementById('wsUrl').value
            };

            await sendCommand(selectedDevice, 'set_system', settings);
            showToast('ƒê√£ g·ª≠i c·∫•u h√¨nh h·ªá th·ªëng!');
        }

        // ========== Init ==========
        refreshDevices();
        setInterval(refreshDevices, 10000);

        // Close modal on outside click
        document.getElementById('configModal').addEventListener('click', (e) => {
            if (e.target.classList.contains('modal-overlay')) closeConfig();
        });
    </script>
</body>

</html>